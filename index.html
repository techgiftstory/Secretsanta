<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Secret Santa üéÖ</title>

<style>
/* =========================
   MOBILE-FIRST BASE
   ========================= */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: radial-gradient(circle at top, #222, #000);
    color: #fff;
    overflow: hidden;

    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

/* =========================
   SNOW
   ========================= */
#snow {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
}

/* =========================
   MAIN CARD (MOBILE OPTIMIZED)
   ========================= */
.card {
    position: relative;
    z-index: 2;
    width: 90vw;
    max-width: 380px;
    padding: 26px 22px;
    border-radius: 18px;
    background: rgba(28, 28, 28, 0.95);
    box-shadow: 0 0 30px rgba(255,255,255,0.18);
    text-align: center;
}

.card h2 {
    margin: 0 0 18px;
    font-size: 26px;
}

/* =========================
   INPUTS & BUTTON
   ========================= */
select {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    margin-bottom: 16px;
}

button {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    background: crimson;
    color: white;
    cursor: pointer;
}

.result {
    margin-top: 22px;
    font-size: 20px;
    line-height: 1.4;
}

/* =========================
   DANCING SANTA (SAFE)
   ========================= */
.santa {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 90px;
    z-index: 2;
    animation: bounce 1.2s infinite alternate;
}

@keyframes bounce {
    from { transform: translateY(0); }
    to { transform: translateY(-14px); }
}
</style>
</head>

<body>

<!-- ‚ùÑÔ∏è Snow -->
<canvas id="snow"></canvas>

<!-- üéÖ Dancing Santa -->
<img
  src="https://tenor.com/en-IN/view/sports-sportsmanias-emoji-animated-emojis-merry-christmas-gif-19449248"
  class="santa"
  alt="Dancing Santa">

<!-- üéÅ MAIN UI -->
<div class="card">
    <h2>üéÅ Secret Santa</h2>

    <select id="nameSelect">
        <option value="">Select your name</option>
    </select>

    <button onclick="revealSanta()">Reveal My Santa</button>

    <div class="result" id="result"></div>
</div>

<script>
/* =====================================================
   üîí FIXED SEED (DO NOT CHANGE)
   ===================================================== */
const SEED = "SECRET-SANTA-2025-DEC-20";

/* =====================================================
   HASH FOR data.txt CHANGE DETECTION
   ===================================================== */
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return hash.toString();
}

/* =====================================================
   SEEDED RANDOM (DETERMINISTIC)
   ===================================================== */
function seededRandom(seed) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < seed.length; i++) {
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
    }
    return function () {
        h += h << 13; h ^= h >>> 7;
        h += h << 3;  h ^= h >>> 17;
        h += h << 5;
        return (h >>> 0) / 4294967296;
    };
}

const rand = seededRandom(SEED);

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

/* =====================================================
   USED NAMES STORAGE
   ===================================================== */
function getUsedNames() {
    return JSON.parse(localStorage.getItem("usedNames") || "[]");
}

function saveUsedName(name) {
    const used = getUsedNames();
    if (!used.includes(name)) {
        used.push(name);
        localStorage.setItem("usedNames", JSON.stringify(used));
    }
}

/* =====================================================
   SECRET SANTA LOGIC
   ===================================================== */
let assignments = {};
let peopleData = [];

fetch('data.txt')
    .then(res => res.text())
    .then(text => {

        // detect data.txt change
        const newHash = hashString(text);
        const oldHash = localStorage.getItem("dataHash");

        if (newHash !== oldHash) {
            localStorage.removeItem("usedNames");
            localStorage.setItem("dataHash", newHash);
        }

        peopleData = text.trim().split('\n').map(line => {
            const [name, status] = line.split(',');
            return {
                name: name.trim(),
                present: status.trim().toLowerCase() === 'true'
            };
        });

        populateDropdown();
        generateAssignments();
    });

function populateDropdown() {
    const select = document.getElementById('nameSelect');
    select.innerHTML = '<option value="">Select your name</option>';

    const usedNames = getUsedNames();

    peopleData.forEach(p => {
        if (!usedNames.includes(p.name)) {
            const opt = document.createElement('option');
            opt.value = p.name;
            opt.textContent = p.name;
            select.appendChild(opt);
        }
    });
}

function generateAssignments() {
    const present = peopleData.filter(p => p.present).map(p => p.name);
    const absent  = peopleData.filter(p => !p.present).map(p => p.name);

    shuffle(present);
    shuffle(absent);

    assignCircular(present);
    assignCircular(absent);
}

function assignCircular(group) {
    if (group.length < 2) return;
    for (let i = 0; i < group.length; i++) {
        assignments[group[i]] = group[(i + 1) % group.length];
    }
}

function revealSanta() {
    const select = document.getElementById('nameSelect');
    const name = select.value;
    const result = document.getElementById('result');

    if (!name) {
        result.textContent = "Please select your name.";
        return;
    }

    result.innerHTML = `üéÑ You are Secret Santa for:<br><strong>${assignments[name]}</strong>`;

    saveUsedName(name);
    select.querySelector(`option[value="${name}"]`).remove();
    select.value = "";
}

/* =====================================================
   ‚ùÑÔ∏è SNOWFALL
   ===================================================== */
const canvas = document.getElementById("snow");
const ctx = canvas.getContext("2d");

let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;

let flakes = Array.from({ length: 110 }, () => ({
    x: Math.random() * w,
    y: Math.random() * h,
    r: Math.random() * 3 + 1,
    d: Math.random() + 1
}));

let angle = 0;
function drawSnow() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "white";
    ctx.beginPath();
    flakes.forEach(f => {
        ctx.moveTo(f.x, f.y);
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
    });
    ctx.fill();

    angle += 0.01;
    flakes.forEach(f => {
        f.y += Math.pow(f.d, 2) + 1;
        f.x += Math.sin(angle);
        if (f.y > h) {
            f.y = 0;
            f.x = Math.random() * w;
        }
    });
}

setInterval(drawSnow, 25);

window.onresize = () => {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
};
</script>

</body>
</html>
